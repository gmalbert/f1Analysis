name: Keep Streamlit App Alive

# This workflow pings the Streamlit app to prevent it from going to sleep
# due to inactivity on Streamlit Community Cloud.
#
# Features:
# - Runs every 30 minutes with 0-10 minute randomization (pings every ~30-40 minutes)
# - Adds random delay to vary timing and make logs look more natural
# - Tolerates failures without breaking the workflow
#
# To use in another repository:
# 1. Copy this file to .github/workflows/
# 2. Update the STREAMLIT_APP_URL below with your app's URL
# 3. Adjust the schedule if needed (currently runs every 30 minutes)
# 4. Adjust DELAY calculation to change random window (currently 0-20 min)

on:
  schedule:
    # Run every 30 minutes with randomization (pings roughly every 30-40 minutes)
    - cron: '*/30 * * * *'
  
  workflow_dispatch:  # Allow manual trigger for testing

env:
  # UPDATE THIS: Replace with your Streamlit app URL
  STREAMLIT_APP_URL: 'https://f1analysis-app.streamlit.app/'

jobs:
  ping-app:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Allow for 10-minute random delay + ping time

    steps:
      - name: Random delay (0-10 minutes)
        run: |
          # Add random delay to vary timing and make logs look more natural
          DELAY=$((RANDOM % 600))  # 0-600 seconds (0-10 minutes)
          echo "‚è≥ Waiting ${DELAY} seconds before ping..."
          sleep $DELAY
      
      - name: Ping Streamlit App
        run: |
          echo "üîî Pinging Streamlit app at: ${{ env.STREAMLIT_APP_URL }}"
          echo "   Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # Make HTTP request with timeout (use generic browser-like User-Agent)
          USER_AGENTS=(
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
          )
          RANDOM_UA=${USER_AGENTS[$RANDOM % ${#USER_AGENTS[@]}]}
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 30 \
            --retry 2 \
            --retry-delay 5 \
            --user-agent "$RANDOM_UA" \
            "${{ env.STREAMLIT_APP_URL }}")
          
          echo "   Response code: $RESPONSE"
          
          # Check if request was successful (2xx or 3xx status codes)
          if [ "$RESPONSE" -ge 200 ] && [ "$RESPONSE" -lt 400 ]; then
            echo "‚úÖ App is alive and responding!"
            exit 0
          else
            echo "‚ö†Ô∏è  App returned status code: $RESPONSE"
            echo "   This might be temporary - will retry on next schedule"
            exit 0  # Don't fail the workflow, just log the issue
          fi

      - name: Log completion
        if: always()
        run: |
          echo "üìä Keep-alive ping completed"
          echo "   Next scheduled run: Check the Actions tab for schedule"
